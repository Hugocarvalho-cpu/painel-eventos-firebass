<!DOCTYPE html>
<html>
<head>
  <title>Painel de Eventos</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: auto; background-color: #f3f0f7; color: #333; }
    h1, h2 { color: #6a0dad; }
    input, select, button, textarea { margin: 5px 0; padding: 8px; border: 1px solid #ccc; border-radius: 5px; width: 100%; }
    button { background-color: #6a0dad; color: white; border: none; cursor: pointer; }
    button:hover { background-color: #581b9a; }
    #adminPanel, #loginPanel { display: none; }
    .log-entry { font-size: 0.9em; border-bottom: 1px solid #ccc; padding: 5px 0; }
  </style>
</head>
<body>
<h1>Painel de Eventos</h1>
<div id="userPanel">
  <h2>Reservar Evento</h2>
  <label>Seu Nick: <input type="text" id="nickInput"></label><br><br>
  <label>Eventos Disponíveis:</label><br>
  <select id="eventSelect"></select><br><br>
  <button onclick="reserveEvent()">Reservar</button>
  <button onclick="showLogin()">Login Admin</button>
</div>

<div id="loginPanel">
  <h2>Login Admin</h2>
  <label>Usuário: <input type="text" id="adminUser"></label><br><br>
  <label>Senha: <input type="password" id="adminPass"></label><br><br>
  <button onclick="loginAdmin()">Entrar</button>
  <button onclick="showUserPanel()">Cancelar</button>
</div>

<div id="adminPanel">
  <h2>Painel Admin</h2>
  <label>Adicionar Evento (um por linha):</label><br>
  <textarea id="newEvent" rows="4" placeholder="Digite os nomes dos eventos separados por linha"></textarea>
  <button onclick="addEvent()">Adicionar</button><br><br>

  <label>Eventos:</label>
  <select id="eventAdminSelect"></select><br>
  <button onclick="removeEvent()">Remover Evento</button>
  <button onclick="unreserveEvent()">Retirar Reserva</button>
  <button onclick="renameEvent()">Renomear Evento</button>
  <button onclick="toggleBlockEvent()">Bloquear/Desbloquear Evento</button><br><br>

  <button onclick="resetAll()">Resetar Tudo</button>
  <button onclick="resetLogs()">Resetar Logs</button>
  <button onclick="toggleGlobalBlock()">Bloquear/Desbloquear Reservas</button><br><br>

  <button onclick="logoutAdmin()">Logout</button>

  <h3>Logs de Reservas</h3>
  <div id="logContainer"></div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyA7R1solmwmOAbHCs2kWpMgDH05s4H-5e8",
    authDomain: "paineleventos-eb268.firebaseapp.com",
    databaseURL: "https://paineleventos-eb268-default-rtdb.firebaseio.com",
    projectId: "paineleventos-eb268",
    storageBucket: "paineleventos-eb268.appspot.com",
    messagingSenderId: "1058039759873",
    appId: "1:1058039759873:web:2b504e42531517be60ec00"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let isAdmin = false;
  const adminUser = "admin";
  const adminPass = "adm11";

  function showLogin() {
    document.getElementById('userPanel').style.display = 'none';
    document.getElementById('loginPanel').style.display = 'block';
    document.getElementById('adminPanel').style.display = 'none';
  }

  function showUserPanel() {
    document.getElementById('userPanel').style.display = 'block';
    document.getElementById('loginPanel').style.display = 'none';
    document.getElementById('adminPanel').style.display = 'none';
  }

  function showAdminPanel() {
    document.getElementById('userPanel').style.display = 'none';
    document.getElementById('loginPanel').style.display = 'none';
    document.getElementById('adminPanel').style.display = 'block';
    loadEvents();
    loadLogs();
  }

  function loginAdmin() {
    const user = document.getElementById('adminUser').value;
    const pass = document.getElementById('adminPass').value;
    if(user === adminUser && pass === adminPass) {
      isAdmin = true;
      showAdminPanel();
    } else {
      alert("Usuário ou senha incorretos!");
    }
  }

  function logoutAdmin() {
    isAdmin = false;
    showUserPanel();
  }

  function loadEvents() {
    const select = document.getElementById('eventSelect');
    const adminSelect = document.getElementById('eventAdminSelect');
    select.innerHTML = '';
    adminSelect.innerHTML = '';
    db.ref('events').once('value').then(snapshot => {
      const events = snapshot.val() || {};
      for(let key in events) {
        const e = events[key];
        const text = e.name + (e.reservedBy ? ` (Reservado por ${e.reservedBy})` : '') + (e.blocked ? " [BLOQUEADO]" : "");
        const option1 = new Option(text, key);
        const option2 = new Option(text, key);
        select.appendChild(option1);
        adminSelect.appendChild(option2);
      }
    });
  }

  async function addEvent() {
    if(!isAdmin) return;

    let namesRaw = document.getElementById('newEvent').value.trim();
    if (!namesRaw) return alert("Digite pelo menos um nome de evento.");

    // Quebrar por linha e limpar espaços
    const names = namesRaw.split('\n').map(n => n.trim()).filter(n => n.length > 0);

    if (names.length === 0) return alert("Digite pelo menos um nome de evento válido.");

    const snapshot = await db.ref('events').once('value');
    const events = snapshot.val() || {};
    const existingNames = Object.values(events).map(e => e.name.toLowerCase());

    // Filtrar só os que não existem ainda (case insensitive)
    const filteredNames = names.filter(name => !existingNames.includes(name.toLowerCase()));

    if (filteredNames.length === 0) {
      alert("Todos os eventos digitados já existem.");
      return;
    }

    // Adicionar todos os eventos filtrados
    const updates = {};
    filteredNames.forEach(name => {
      const newKey = db.ref('events').push().key;
      updates[newKey] = { name, reservedBy: null, blocked: false };
    });

    db.ref('events').update(updates).then(() => {
      alert(`Adicionado(s) evento(s):\n${filteredNames.join('\n')}`);
      document.getElementById('newEvent').value = '';
      loadEvents();
    });
  }

  function removeEvent() {
    const key = document.getElementById('eventAdminSelect').value;
    if (!key) return alert("Selecione um evento para remover.");
    db.ref('events/' + key).remove().then(loadEvents);
  }

  async function unreserveEvent() {
    const key = document.getElementById('eventAdminSelect').value;
    if (!key) return alert("Selecione um evento para retirar a reserva.");

    // Buscar evento para saber quem reservou
    const eventSnap = await db.ref('events/' + key).once('value');
    const event = eventSnap.val();
    if (!event) return alert("Evento inválido.");
    if (!event.reservedBy) return alert("Evento não está reservado.");

    const reservedNick = event.reservedBy;

    // Remover a reserva
    await db.ref('events/' + key + '/reservedBy').remove();

    // Buscar logs relacionados e remover
    const logsSnap = await db.ref('logs').once('value');
    const logs = logsSnap.val() || {};
    for (const logKey in logs) {
      const log = logs[logKey];
      // Remover log que tenha o mesmo staff (nick) e o mesmo evento (nome)
      if (log.staff === reservedNick && log.event === event.name) {
        await db.ref('logs/' + logKey).remove();
        break;  // Remove só o primeiro que encontrar
      }
    }

    alert("Reserva retirada e log removido.");
    loadEvents();
    loadLogs();
  }

  function renameEvent() {
    const key = document.getElementById('eventAdminSelect').value;
    if (!key) return alert("Selecione um evento para renomear.");
    
    const newName = prompt("Novo nome do evento:");
    if (!newName || !newName.trim()) return alert("Nome inválido.");
    
    const trimmedName = newName.trim();

    db.ref('events').once('value').then(snapshot => {
      const events = snapshot.val() || {};
      const exists = Object.values(events).some(e => e.name.toLowerCase() === trimmedName.toLowerCase());
      if (exists) {
        alert("Já existe um evento com esse nome. Escolha outro nome.");
        return;
      }
      db.ref('events/' + key + '/name').set(trimmedName).then(() => {
        alert("Evento renomeado com sucesso.");
        loadEvents();
      });
    });
  }

  function toggleBlockEvent
