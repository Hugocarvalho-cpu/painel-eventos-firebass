<!DOCTYPE html>
<html>
<head>
  <title>Painel de Eventos</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: auto; background-color: #f3f0f7; color: #333; }
    h1, h2 { color: #6a0dad; }
    input, select, button, textarea { margin: 5px 0; padding: 8px; border: 1px solid #ccc; border-radius: 5px; width: 100%; }
    button { background-color: #6a0dad; color: white; border: none; cursor: pointer; }
    button:hover { background-color: #581b9a; }
    #adminPanel, #loginPanel { display: none; }
    .log-entry { font-size: 0.9em; border-bottom: 1px solid #ccc; padding: 5px 0; }
  </style>
</head>
<body>
<h1>Painel de Eventos</h1>
<div id="userPanel">
  <h2>Reservar Evento</h2>
  <label>Seu Nick: <input type="text" id="nickInput"></label><br><br>
  <label>Eventos Disponíveis:</label><br>
  <select id="eventSelect"></select><br><br>
  <button onclick="reserveEvent()">Reservar</button>
  <button onclick="showLogin()">Login Admin</button>
</div>

<div id="loginPanel">
  <h2>Login Admin</h2>
  <label>Usuário: <input type="text" id="adminUser"></label><br><br>
  <label>Senha: <input type="password" id="adminPass"></label><br><br>
  <button onclick="loginAdmin()">Entrar</button>
  <button onclick="showUserPanel()">Cancelar</button>
</div>

<div id="adminPanel">
  <h2>Painel Admin</h2>
  <label>Adicionar Evento (um por linha):</label><br>
  <textarea id="newEvent" rows="4" placeholder="Digite os nomes dos eventos separados por linha"></textarea>
  <button onclick="addEvent()">Adicionar</button><br><br>

  <label>Eventos:</label>
  <select id="eventAdminSelect"></select><br>
  <button onclick="removeEvent()">Remover Evento</button>
  <button onclick="unreserveEvent()">Retirar Reserva</button>
  <button onclick="renameEvent()">Renomear Evento</button>
  <button onclick="toggleBlockEvent()">Bloquear/Desbloquear Evento</button><br><br>

  <button onclick="resetAll()">Resetar Tudo</button>
  <button onclick="resetLogs()">Resetar Logs</button>
  <button onclick="toggleGlobalBlock()">Bloquear/Desbloquear Reservas</button><br><br>

  <button onclick="logoutAdmin()">Logout</button>

  <h3>Logs de Reservas</h3>
  <div id="logContainer"></div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyA7R1solmwmOAbHCs2kWpMgDH05s4H-5e8",
    authDomain: "paineleventos-eb268.firebaseapp.com",
    databaseURL: "https://paineleventos-eb268-default-rtdb.firebaseio.com",
    projectId: "paineleventos-eb268",
    storageBucket: "paineleventos-eb268.appspot.com",
    messagingSenderId: "1058039759873",
    appId: "1:1058039759873:web:2b504e42531517be60ec00"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let isAdmin = false;
  const adminUser = "admin";
  const adminPass = "adm11";

  function showLogin() {
    document.getElementById('userPanel').style.display = 'none';
    document.getElementById('loginPanel').style.display = 'block';
    document.getElementById('adminPanel').style.display = 'none';
  }

  function showUserPanel() {
    document.getElementById('userPanel').style.display = 'block';
    document.getElementById('loginPanel').style.display = 'none';
    document.getElementById('adminPanel').style.display = 'none';
    loadEvents();
  }

  function showAdminPanel() {
    document.getElementById('userPanel').style.display = 'none';
    document.getElementById('loginPanel').style.display = 'none';
    document.getElementById('adminPanel').style.display = 'block';
    loadEvents();
    loadLogs();
  }

  function loginAdmin() {
    const user = document.getElementById('adminUser').value;
    const pass = document.getElementById('adminPass').value;
    if(user === adminUser && pass === adminPass) {
      isAdmin = true;
      showAdminPanel();
    } else {
      alert("Usuário ou senha incorretos!");
    }
  }

  function logoutAdmin() {
    isAdmin = false;
    showUserPanel();
  }

  function loadEvents() {
    const select = document.getElementById('eventSelect');
    const adminSelect = document.getElementById('eventAdminSelect');
    select.innerHTML = '';
    adminSelect.innerHTML = '';
    db.ref('events').once('value').then(snapshot => {
      const events = snapshot.val() || {};
      for(let key in events) {
        const e = events[key];
        const text = e.name + (e.reservedBy ? ` (Reservado por ${e.reservedBy})` : '') + (e.blocked ? " [BLOQUEADO]" : "");
        const option1 = new Option(text, key);
        const option2 = new Option(text, key);
        select.appendChild(option1);
        adminSelect.appendChild(option2);
      }
    });
  }

  function reserveEvent() {
    const nick = document.getElementById('nickInput').value.trim();
    const key = document.getElementById('eventSelect').value;
    if (!nick || !key) return alert("Preencha seu nick e selecione um evento.");

    db.ref('events/' + key).once('value').then(snapshot => {
      const event = snapshot.val();
      if (!event) return alert("Evento inválido.");
      if (event.reservedBy) return alert("Esse evento já está reservado.");
      if (event.blocked) return alert("Esse evento está bloqueado para reservas.");

      db.ref('events/' + key + '/reservedBy').set(nick);
      db.ref('logs').push({ staff: nick, event: event.name, timestamp: Date.now() });
      alert("Evento reservado com sucesso!");
      loadEvents();
    });
  }

  function loadLogs() {
    const container = document.getElementById('logContainer');
    container.innerHTML = '';
    db.ref('logs').once('value').then(snapshot => {
      const logs = snapshot.val() || {};
      const sortedLogs = Object.values(logs).sort((a, b) => b.timestamp - a.timestamp);
      for (const log of sortedLogs) {
        const div = document.createElement('div');
        div.className = 'log-entry';
        const date = new Date(log.timestamp).toLocaleString();
        div.textContent = `${log.staff} reservou "${log.event}" em ${date}`;
        container.appendChild(div);
      }
    });
  }

  function toggleBlockEvent() {
    const key = document.getElementById('eventAdminSelect').value;
    if (!key) return alert("Selecione um evento.");

    db.ref('events/' + key).once('value').then(snapshot => {
      const event = snapshot.val();
      if (!event) return alert("Evento inválido.");

      const newBlocked = !event.blocked;
      db.ref('events/' + key + '/blocked').set(newBlocked).then(() => {
        alert(newBlocked ? "Evento bloqueado." : "Evento desbloqueado.");
        loadEvents();
      });
    });
  }

  function resetAll() {
    if (!confirm("Tem certeza que deseja resetar todos os eventos?")) return;
    db.ref('events').remove().then(loadEvents);
    db.ref('logs').remove().then(loadLogs);
  }

  function resetLogs() {
    if (!confirm("Tem certeza que deseja apagar todos os logs?")) return;
    db.ref('logs').remove().then(loadLogs);
  }

  function toggleGlobalBlock() {
    db.ref('globalBlocked').once('value').then(snapshot => {
      const blocked = snapshot.val();
      db.ref('globalBlocked').set(!blocked).then(() => {
        alert(!blocked ? "Reservas bloqueadas globalmente." : "Reservas desbloqueadas.");
      });
    });
  }

  // Ao carregar a página, mostrar painel de usuário e carregar eventos
  window.onload = () => {
    showUserPanel();
  };
</script>
</body>
</html>
